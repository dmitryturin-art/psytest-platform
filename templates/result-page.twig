{% extends "layout.twig" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {{ test.name }} - {{ appName }}{% endblock %}

{% block body_class %}results-page test-{{ test.slug }}{% endblock %}

{% block content %}
<div class="results-wrapper">
    <!-- Results Header -->
    <div class="results-header">
        <h1 class="results-title">{{ test.name }}</h1>
        <p class="results-subtitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
        
        <div class="results-meta">
            <span class="meta-item">
                <span class="meta-icon">üìÖ</span>
                {{ session.created_at|date("d.m.Y H:i") }}
            </span>
            <span class="meta-item">
                <span class="meta-icon">üîó</span>
                ID: {{ session.id|slice(0, 8) }}...
            </span>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="results-actions">
        <a href="{{ basePath }}/result/{{ test.slug }}/{{ session.session_token }}/pdf"
           class="btn btn-secondary" target="_blank">
            üìÑ –°–∫–∞—á–∞—Ç—å PDF
        </a>
        {% if ai_interpretation_available %}
        <a href="{{ basePath }}/interpretation/{{ session.session_token }}"
           class="btn btn-primary">
            ‚ú® –ü–æ–ª—É—á–∏—Ç—å AI-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é
        </a>
        {% endif %}
        <button class="btn btn-outline" onclick="copyResultLink()">
            üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>
        <button class="btn btn-outline" onclick="openDeleteModal()">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        </button>
    </div>

    <!-- Results Content -->
    <div class="results-content">
        {{ results_html|raw }}
    </div>

    <!-- Disclaimer -->
    <div class="results-disclaimer">
        <p>
            <strong>–í–∞–∂–Ω–æ:</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ—Å—è—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä 
            –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –¥–∏–∞–≥–Ω–æ–∑–æ–º. –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π 
            –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
        </p>
    </div>

    <!-- Pair Comparison (if available) -->
    {% if pair_comparison %}
    <div class="pair-comparison">
        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º</h2>
        <div class="comparison-content">
            {{ pair_comparison_html|raw }}
        </div>
        <a href="{{ basePath }}/pair/{{ pair_comparison.id }}/pdf" 
           class="btn btn-secondary" target="_blank">
            üìÑ –°–∫–∞—á–∞—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ PDF
        </a>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal" style="display: none">
    <div class="modal-content modal-danger">
        <h3>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ?</h3>
        <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Å—Ç–∞–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" onclick="confirmDelete()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Link Copy Notification -->
<div class="toast" id="copyToast" style="display: none">
    ‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ basePath }}/js/smil-profile-classic.js?v={{ "now"|date("U") }}"></script>
<script src="{{ basePath }}/js/smil-profile.js?v={{ "now"|date("U") }}"></script>
<script src="{{ basePath }}/js/smil-scale-indicator.js?v={{ "now"|date("U") }}"></script>
<script>
// Initialize scale indicators after page load
document.addEventListener('DOMContentLoaded', function() {
    // Get T-scores from chart data if available
    const chartCanvas = document.getElementById('smilProfileChart');
    if (chartCanvas) {
        const scores = JSON.parse(chartCanvas.getAttribute('data-scores') || '[]');
        const labels = JSON.parse(chartCanvas.getAttribute('data-labels') || []);
        
        // Create visual indicators for each scale
        scores.forEach((score, index) => {
            const scaleCode = labels[index] || index;
            const containerId = 'scale-viz-' + scaleCode;
            const container = document.getElementById(containerId);
            if (container && window.createScaleIndicator) {
                window.createScaleIndicator(score, containerId);
            }
        });
    }
});
</script>
{% endblock %}

{% block extra_js %}
<script>
const RESULT_CONFIG = {
    sessionId: '{{ session.id }}',
    sessionToken: '{{ session.session_token }}',
    testSlug: '{{ test.slug }}',
    basePath: '{{ basePath }}',
};

function copyResultLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        const toast = document.getElementById('copyToast');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    });
}

function openDeleteModal() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
    fetch(`${RESULT_CONFIG.basePath}/result/${RESULT_CONFIG.sessionToken}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `${RESULT_CONFIG.basePath}/deleted`;
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(err => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + err.message);
    });
}

// Close modal on outside click
document.getElementById('deleteModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteModal') {
        closeDeleteModal();
    }
});
</script>
<script src="{{ basePath }}/js/results.js"></script>
{% endblock %}
