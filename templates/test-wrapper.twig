{% extends "layout.twig" %}

{% block title %}{{ test.name }} - {{ appName }}{% endblock %}

{% block body_class %}test-page test-{{ test.slug }}{% endblock %}

{% block content %}
<div class="test-wrapper">
    <!-- Test Header -->
    <div class="test-header">
        <h1 class="test-title">{{ test.name }}</h1>
        <p class="test-description">{{ test.description }}</p>
        
        <div class="test-meta">
            <span class="meta-item">
                <span class="meta-icon">üìù</span>
                {{ test.question_count }} –≤–æ–ø—Ä–æ—Å–æ–≤
            </span>
            <span class="meta-item">
                <span class="meta-icon">‚è±Ô∏è</span>
                ~{{ test.estimated_time }} –º–∏–Ω—É—Ç
            </span>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <span class="progress-text" id="progressText">0 / {{ test.question_count }}</span>
    </div>

    <!-- Test Form -->
    <form id="testForm" class="test-form" method="POST" action="{{ basePath }}/test/{{ test.slug }}/submit">
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="session_id" value="{{ session.id }}">

        <!-- Demographics Section (only if required by module) -->
        {% set demoReq = module.getDemographicsRequirements()|default({}) %}
        {% if demoReq.gender is defined and demoReq.gender %}
        <div class="demographics-section" id="demographicsSection">
            <h3 class="demographics-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–µ</h3>
            <p class="demographics-subtitle">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>

            <div class="demographics-options">
                <label class="demographic-option">
                    <input type="radio" name="demographics[gender]" value="male" required>
                    <span class="option-icon">üë®</span>
                    <span class="option-label">–ú—É–∂—Å–∫–æ–π</span>
                </label>
                <label class="demographic-option">
                    <input type="radio" name="demographics[gender]" value="female" required>
                    <span class="option-icon">üë©</span>
                    <span class="option-label">–ñ–µ–Ω—Å–∫–∏–π</span>
                </label>
            </div>

            {% if demoReq.age is defined and demoReq.age %}
            <div class="age-input-group">
                <label for="demographicsAge">–í–∞—à –≤–æ–∑—Ä–∞—Å—Ç:</label>
                <input type="number" id="demographicsAge" name="demographics[age]"
                       min="{{ demoReq.min_age|default(14) }}"
                       max="{{ demoReq.max_age|default(100) }}"
                       placeholder="{{ demoReq.min_age|default(14) }}-{{ demoReq.max_age|default(100) }}" required>
                <small>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: {{ demoReq.min_age|default(14) }} –ª–µ—Ç</small>
            </div>
            {% endif %}

            <button type="button" class="btn btn-primary btn-lg" id="startTestBtn">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí</button>
        </div>
        {% endif %}

        <!-- Questions Container (hidden until demographics completed) -->
        <div class="questions-container" id="questionsContainer" style="display: none;">
            {% for question in questions %}
            <div class="question-card" data-question-id="{{ question.id }}"
                 {% if question.text_male is defined %}data-text-male="{{ question.text_male }}"{% endif %}
                 {% if question.text_female is defined %}data-text-female="{{ question.text_female }}"{% endif %}>
                <p class="question-text">{{ question.id }}. {{ question.text ?? question.text_male ?? question.text_female }}</p>
                <div class="answer-options{% if test.answer_type == 'ternary' %} has-ternary{% endif %}">
                    {% if question.options is defined and question.options is not empty %}
                        {% for option in question.options %}
                        <label class="answer-option">
                            <input type="radio" name="answers[{{ question.id }}]" value="{{ option.value }}" required>
                            <span class="option-text">{{ option.text }}</span>
                        </label>
                        {% endfor %}
                    {% elseif test.answer_type == 'ternary' %}
                        <label class="answer-option answer-true">
                            <input type="radio" name="answers[{{ question.id }}]" value="1" required>
                            <span class="option-text">–í–µ—Ä–Ω–æ</span>
                        </label>
                        <label class="answer-option answer-false">
                            <input type="radio" name="answers[{{ question.id }}]" value="0" required>
                            <span class="option-text">–ù–µ–≤–µ—Ä–Ω–æ</span>
                        </label>
                        <label class="answer-option answer-unknown">
                            <input type="radio" name="answers[{{ question.id }}]" value="2" required>
                            <span class="option-text">–ù–µ –∑–Ω–∞—é</span>
                        </label>
                    {% else %}
                        <label class="answer-option">
                            <input type="radio" name="answers[{{ question.id }}]" value="true" required>
                            <span class="option-text">–î–∞</span>
                        </label>
                        <label class="answer-option">
                            <input type="radio" name="answers[{{ question.id }}]" value="false" required>
                            <span class="option-text">–ù–µ—Ç</span>
                        </label>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Navigation Buttons (hidden until demographics completed) -->
        <div class="test-navigation" id="testNavigation" style="display: none;">
            <button type="button" class="btn btn-secondary" id="prevBtn" style="visibility: hidden">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn">
                –î–∞–ª–µ–µ ‚Üí
            </button>
            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none">
                ‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
        </div>
    </form>

    <!-- Completion Notice -->
    <div class="completion-notice" id="completionNotice" style="display: none">
        <div class="notice-icon">üéâ</div>
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
        <p>–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è...</p>
    </div>
</div>

<!-- Delete Data Modal -->
<div class="modal" id="deleteModal" style="display: none">
    <div class="modal-content">
        <h3>–£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ?</h3>
        <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const TEST_CONFIG = {
    slug: '{{ test.slug }}',
    totalQuestions: {{ test.question_count }},
    sessionToken: '{{ session.session_token }}',
    basePath: '{{ basePath }}',
};
</script>
<script src="{{ basePath }}/js/test-taking.js?v={{ "now"|date("U") }}"></script>
{% if module.getCustomJavaScript() %}
<script src="{{ module.getCustomJavaScript() }}?v={{ "now"|date("U") }}"></script>
{% endif %}
{% endblock %}
